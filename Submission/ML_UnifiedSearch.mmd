sequenceDiagram
    participant User
    participant MacApp as Mac Vault App
    participant NLP as spaCy NLP
    participant Cache as Embedding Cache
    participant OpenAI as OpenAI API
    participant PG as PostgreSQL pgvector
    participant Ranker as Hybrid Ranking Engine
    participant CRDT as CRDT Sync
    participant iPhone
    
    Note over User,iPhone: Unified Search System Two Search Modes
    
    alt Mode A Text Query Search
        User->>MacApp: Enter text query vacation plans
        
        Note over MacApp,OpenAI: Text Query Processing
        
        MacApp->>NLP: Preprocess query text
        NLP->>NLP: Tokenization and lemmatization
        NLP-->>MacApp: Cleaned text vacation plan
        
        MacApp->>OpenAI: Generate query embedding
        OpenAI-->>MacApp: Return 1536 dimensional vector
        
        MacApp->>PG: Execute simple vector similarity query
        PG->>PG: HNSW index navigation
        PG->>PG: Calculate cosine similarity
        PG-->>MacApp: Return 10 ranked results by similarity
        
    else Mode B Calendar Event Search
        User->>MacApp: View calendar event Q4 Planning Meeting
        User->>MacApp: Click Find Related Messages
        
        Note over MacApp,OpenAI: Calendar Event Processing
        
        MacApp->>MacApp: Combine event fields into text
        MacApp->>Cache: Check cache for event
        
        alt Embedding cached
            Cache-->>MacApp: Return cached embedding
        else Not cached
            MacApp->>OpenAI: Generate event embedding
            OpenAI-->>MacApp: Return 1536 dimensional vector
            MacApp->>Cache: Store embedding in cache
        end
        
        Note over MacApp,PG: Hybrid Query with 4 Filters
        
        MacApp->>PG: Execute hybrid SQL query
        
        Note over PG: Filter 1 Semantic similarity via vector
        Note over PG: Filter 2 Temporal proximity 7 days window
        Note over PG: Filter 3 Participant overlap
        Note over PG: Filter 4 Platform preference
        
        PG->>PG: Apply temporal filter
        PG->>PG: Apply participant filter  
        PG->>PG: HNSW vector search
        
        PG-->>MacApp: Return 50 candidate messages
        
        Note over MacApp,Ranker: Hybrid Re-Ranking with 3 Weighted Components
        
        MacApp->>Ranker: Re-rank 50 candidates
        
        loop For each candidate message
            Ranker->>Ranker: Calculate semantic score 60 percent weight
            Ranker->>Ranker: Calculate temporal score 20 percent weight
            Ranker->>Ranker: Calculate participant score 20 percent weight
            Ranker->>Ranker: Compute weighted final score
        end
        
        Ranker->>Ranker: Sort by final score descending
        Ranker->>Ranker: Take top 10 results
        
        Ranker-->>MacApp: Return ranked results with scores
    end
    
    Note over MacApp,iPhone: Result Enrichment and Display
    
    MacApp->>MacApp: Enrich results with metadata
    MacApp->>MacApp: Resolve contact names
    MacApp->>MacApp: Load platform icons
    MacApp->>MacApp: Format timestamps
    MacApp->>MacApp: Apply user filters optional
    
    MacApp-->>User: Display 10 search results with scores
    
    Note over User,iPhone: User Interactions
    
    User->>MacApp: Click result to view thread
    MacApp->>MacApp: Load full conversation thread
    MacApp->>MacApp: Show message context with history
    MacApp-->>User: Display full thread
    
    User->>MacApp: Click LIKE on result
    MacApp->>MacApp: Record positive feedback
    MacApp->>MacApp: Update weight preferences for calendar mode
    
    User->>MacApp: Filter by platform WhatsApp only
    MacApp->>MacApp: Re-filter results client-side
    MacApp-->>User: Show filtered messages
    
    User->>MacApp: Export results
    MacApp->>MacApp: Generate markdown summary
    MacApp-->>User: Save to Files app or Share via AirDrop
    
    Note over MacApp,iPhone: Cross-Device Sync
    
    alt User saves search
        MacApp->>CRDT: Create saved search with query and results
        CRDT->>iPhone: Sync saved search
        iPhone-->>User: Notification search available
    end
    
    Note over User,iPhone: Multi-Language Search Capability
    
    User->>MacApp: Search in English meeting tomorrow
    MacApp->>OpenAI: Generate embedding
    MacApp->>PG: Vector search
    PG-->>MacApp: Cross-lingual results English Spanish German Japanese
    MacApp-->>User: Display results with language flags
    
    Note over User,iPhone: Algorithm Performance Metrics
    Note over User,iPhone: Query preprocessing 10ms for text mode only
    Note over User,iPhone: Embedding generation 200ms or instant if cached
    Note over User,iPhone: Vector search HNSW 120ms p95 for 100K messages
    Note over User,iPhone: Hybrid re-ranking 30ms for calendar mode only
    Note over User,iPhone: Result enrichment under 50ms
    Note over User,iPhone: Total latency under 400ms sub-second
    Note over User,iPhone: Precision at 10 is 85 percent validated
    Note over User,iPhone: Recall over 95 percent finds relevant messages
    Note over User,iPhone: Multilingual 100 plus languages supported

    %%{init: {'theme':'dark', 'themeVariables': { 
        'actorBkg':'#2563eb',
        'actorBorder':'#60a5fa',
        'actorTextColor':'#ffffff',
        'actorLineColor':'#60a5fa',
        'signalColor':'#e0e7ff',
        'signalTextColor':'#e0e7ff',
        'labelBoxBkgColor':'#1e293b',
        'labelBoxBorderColor':'#475569',
        'labelTextColor':'#f1f5f9',
        'loopTextColor':'#fbbf24',
        'altTextColor':'#fb923c',
        'noteBkgColor':'#065f46',
        'noteBorderColor':'#10b981',
        'noteTextColor':'#ffffff',
        'activationBkgColor':'#7c3aed',
        'activationBorderColor':'#a78bfa',
        'sequenceNumberColor':'#ffffff'
    }}}%%

